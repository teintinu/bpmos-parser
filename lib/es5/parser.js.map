{"version":3,"sources":["parser.js"],"names":[],"mappings":"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","file":"parser.js","sourcesContent":["import yaml from '../yaml'\nimport artifacts from './artifacts'\nimport {initialize} from './types'\n\nimport { basename } from 'path'\nimport { readFileSync } from 'fs'\n\ninitialize()\n\nexport function parseFile (file) {\n  var file_content = readFileSync(file, 'utf-8')\n  return parse(file, file_content)\n}\n\nexport function parse (file, content) {\n  var obj = yaml.parse(file, content, function (type, node, loc) {\n    if (type === 'value') {\n      return {\n        $$val: node,\n        $$used: undefined,\n        $$file: file,\n        $$loc: loc.loc\n      }\n    } else if (type === 'array') {\n      return {\n        $$arr: node,\n        $$used: undefined,\n        $$file: file,\n        $$loc: loc.loc\n      }\n    } else {\n      node.$$used = undefined\n      node.$$file = file\n      node.$$loc = loc.loc\n      return node\n    }\n  })\n  return parseArtifact(basename(file, '.yaml'), obj)\n}\n\nexport function parseArtifact (name, obj) {\n  var keys = Object.keys(obj)\n  var type = keys[0]\n  var obj2 = obj[type]\n  var ret = artifacts.createArtifact(type, name)\n  if (!ret) throwAt(obj, 'invalid artifact type ' + type)\n  var props = ret.getProperties(type)\n  props.forEach(function (prop) {\n    var p = parseProperty(prop, obj, obj2)\n    if (p !== undefined) ret[prop.name] = p\n  })\n  return ret\n}\n\nfunction parseProperty (prop, obj, obj2) {\n  if (obj2 && obj2[prop.name]) obj = obj2\n  var p = obj[prop.name]\n  if (!p) {\n    if (prop.required) throwAt(obj, prop.name + ' is required')\n    return undefined\n  }\n  return prop.type.parse(p)\n}\n\nfunction throwAt (obj, msg) {\n  var err = new Error([\n    msg, ' at ',\n    obj.$$file, ':',\n    obj.$$loc.start.line, ':',\n    obj.$$loc.start.column].join(''))\n  err.file = obj.$$file\n  err.loc = obj.$$loc\n  throw err\n}\n"],"sourceRoot":"/source/"}